# ColorDance 音效整合落地方案

## 1. 互動盤點與優先級

| 流程節點 | 互動 / 事件 | 目前狀態 | 優先級 | 音效建議與備註 |
|----------|-------------|-----------|--------|----------------|
| 啟動 / 載入 (`landing-screen`) | 頁面載入、Logo 動畫、背景泡泡動畫 | 僅有單段 BGM，自動播放；裝飾動畫無音效 | 中 | 增加淡入型環境氛圍（柔和環境 Pad），動畫加入輕微氣泡 / 閃光層，音量 < -18 LUFS，避免干擾開場旁白。 |
| 啟動 / 載入 | `開始遊戲` 按鈕點擊 | 無觸控提示音 | 高 | 依文件建議提供短促 UI 點擊（0.15s 以下），隨機 ±5% pitch；結束時衰減讓 Loading 過渡更順。 |
| 載入中 Overlay | Loading 進度 / 泡泡群動畫 | 無音效 | 中 | 使用細微氣泡群或顆粒滑過聲，循環不宜過長，加入 6-8 秒 Loop，淡入淡出 300ms。 |
| 主畫廊（尚未實作） | 分類切換、圖像卡 hover、選圖開啟 | 未實作音訊 | 中 | 先規劃：分類切換→柔和 UI 滑動；選圖→卡片翻面聲。 |
| 填色畫面 (`game-board`) | 調色盤色塊切換 | 已呼叫 `feedbackService.playColorSwitch` | 高 | 目前為合成音；建議加入多樣素材或調整合成參數，避免頻繁操作疲勞，可引入 3-4 種樣本隨機輪播。 |
| 填色畫面 | 點擊格子填色 | 已呼叫 `playColorFill`；每次填色皆為合成琶音 | 高 | 根據文件建議，引入隨機音高/音量變化，或分階段 Layer（初次填色/連填）；避免長時間合成音造成疲勞，可考慮混合 Foley「啵」聲。 |
| 填色畫面 | 使用橡皮擦 | 已呼叫 `playCellErase` | 中 | 音效合生成分偏高；可疊加「擦拭」樣本，並加入衰減 EQ 切高頻，減少刺耳。 |
| 填色畫面 | 空白格提示 / 自動填色（未實作） | 無 | 中 | 提示→短促升調「叮」；自動填色→漸進閃光聲 + 多重粒子。 |
| 填色畫面 | 檢查答案按鈕 (`onCheckAnswer`) | 已有成功 / 失敗合成音，失敗同時彈窗 | 高 | 成功時加上群眾歡呼 Layer 並控制動態；失敗時可加柔和失敗提示避免過刺耳；Incomplete 應補上提示「未填滿」音效與文字同步。 |
| 填色畫面 | 重置、提示按鈕 (`onReset`, `onGetHint`) | 沒有觸發音效 | 高 | 重置→下降滑動音（提醒重大操作），並在確認框出現時播放「彈窗」提示；提示→柔和升調，重複時加入疲勞保護（音量遞減）。 |
| 填色畫面 | 成功完成後 Result 區塊顯示 | 只有視覺動畫、無音效 | 高 | 依 `遊戲音效解決方案` 建議，加入慶祝層（煙火閃光 + 線條掃過）與 UI 彈窗音，可分為 2 層：立即成功提示 + 長尾環境。 |
| 任務 / 商店（尚未實作） | 貨幣獲取、按鈕切換、購買確認 | 無 | 中 | 先定義音效語彙：金幣→金屬叮噹、提示→柔和氣泡；購買失敗→短促低頻。 |
| 設定（尚未實作） | Toggle 開關、語言切換 | 無 | 低 | 規劃通用 UI 音效集，與主畫面共用。 |
| 環境層 | 背景氛圍、關卡內場景音 | 無 | 中 | 可按關卡主題加入 3D 環境 Loop（低音量），同時設計 Ducking 規則：UI 互動時下降 3 dB。 |
| 無障礙 | 震動 / TTS 同步音訊 | 未規劃 | 中 | 考慮將重要事件音效對應震動（手機），提供音量選項。 |

> 優先級判定規則：直接影響觸控回饋與核心玩法者為「高」、非必須但能提升沉浸感者為「中」、尚未開發或低頻使用者為「低」。

## 2. 音效事件對應表與素材計畫

| 編號 | 事件 / 功能 | 音效類型 | 素材來源建議 | 設計細節 | 實作備註 |
|------|-------------|-----------|---------------|-----------|-----------|
| UI-01 | `開始遊戲` 按鈕、一般 UI 點擊 | UI 回饋（Click） | 自製短促 Foley（敲擊塑膠 / 木頭）或 Sonniss GDC Pack 內 `ui_button_press` 類 | 0.12-0.18s，隨機 ±6% Pitch、±2 dB；左右聲道輕微擺動製造空間感 | 作為 `FeedbackService.playUiClick()` 公用方法，所有按鈕共用 |
| UI-02 | `檢查答案` 未完成提示 | UI 警示 | 自製玻璃敲擊、或 BOOM Library UI；可疊層白噪 | 兩段式音效：短促「Tick」+ 低頻嗡嗡，總長 <0.4s | 搭配輸入震動（行動版），音量 -12 dBFS 基準 |
| UI-03 | 彈窗（重置確認 / 提示結果） | UI 彈出 | FMOD Foley、或免費 UI Swell | 升調 200ms + 衰退 300ms；加入高頻閃光 | 彈窗關閉加入對應淡出音 `playUiDismiss()` |
| GP-01 | 色塊切換 | 互動強化 | 現有合成音 + 新增 3 種樣本 | 依顏色分群（暖色 / 冷色 / 中性）設定不同基頻；Pitch 隨機 | 可使用多重 AudioBuffer 隨機播放，或在 `FeedbackService` 中加入樣本池 |
| GP-02 | 格子填色 | 核心手感 | Foley 啵聲 + 合成琶音 Layer | 前 0.1s 使用 Foley，後 0.3s 以合成琶音升調；連續填色時啟用序列漸進 | 實作連填快時改用「序列」方案：每次遞增半音，3 次後重置 |
| GP-03 | 橡皮擦 | 互動強化 | 布料擦拭或紙張摩擦 | 0.25s 以內，尾端加入氣音 | 若顏色為空值連續擦除，音量逐漸下降避免嘈雜 |
| GP-04 | 提示成功 | UI 正向 | 鈴鐺或馬林巴短音 | Arpeggio 3 音，總長 0.5s；尾端加入閃光 | 消耗資源時同時觸發 `FeedbackService.playCurrencySpend()` |
| GP-05 | 檢查答案成功 | 成就 / 勝利 | 現有和弦 + 新增鼓掌歡呼層 | Layer1：合成和弦；Layer2：群眾歡呼（短 0.8s）；Layer3：火花 | 使用動態混音將 BGM Duck -4 dB，音效主干 -6 dBFS |
| GP-06 | 檢查答案失敗 | 失敗提示 | 低頻滑落 + 柔和敲擊 | 0.4s，避免刺耳；加入短促紅燈提示 | 同時觸發視覺脈衝，音量 -10 dBFS |
| GP-07 | 完成煙火動畫 | 慶祝氛圍 | 可使用 freesound 氣泡 / 炸裂音 Layer | 三層：初始爆裂、彩帶散落、燦爛尾音；合計 1.2s | 與完成畫面入場音分開觸發，避免重疊爆音 |
| ENV-01 | 關卡環境 Loop | 氛圍 | 自製或公共素材（雨聲、城市、室內） | 立體聲 Loop 30-45s，柔和動態；低頻削減 | 視關卡主題切換；與 BGM 混音時 Duck 3 dB |
| ENV-02 | Loading 泡泡動畫 | 氛圍 | 水泡擠壓 / 小鈴 | 0.5s Loop，加入 2-3 種變體隨機 | 透過 Gain Node 0.2 音量播放，避免干擾敘事 |
| SYS-01 | 金幣 / 獎勵 | 成果回饋 | 金屬叮噹 | 3 重音 → 左右聲道交錯 | 未有商店時先於完成畫面中使用 |
| SYS-02 | 負向操作（不可填色、錯誤） | 失敗提示 | 木質敲擊 + 低頻噪 | 0.25s，兩段式：Click -> Sub Drop | `FeedbackService.playInvalidAction()` |
| SYS-03 | 音量設定調整 | UI Slider | 白噪掃頻 | 依 Slider 移動速度改變音高 | 若採 Kit UI，保留為共用資源 |

素材來源說明：
- **現成庫**：Sonniss GDC、GameSounds.xyz、33 Sounds（UI 套件）。
- **自製 Foley**：使用手機 + 錄音筆錄製；後期處理建議用 Audacity/Adobe Audition，加 EQ、壓縮、淡入淡出。
- **程序生成**：延用現有 `FeedbackService` 合成流程，加入多樣參數與疊層。

資產管理建議：
- 音效檔案統一放在 `src/assets/audio/sfx/`，命名 `category_action_variant.wav`；主程式引用 OGG，原始 WAV 存於版本控制外部（或 `audio/sources`）。
- 已存在的音樂檔移至 `src/assets/audio/bgm/`，並更新引用路徑，方便後續管理。

## 3. 技術實作策略

### 3.1 系統架構
- **音效管理層**：擴充現有 `FeedbackService` → `AudioFeedbackService`，職責拆分為
  - `AudioContextGateway`：負責初始化、暫停、恢復。
  - `SfxRegistry`：管理樣本池（Cache + 隨機變體）、音量表、分組。
  - `PlaybackController`：統一觸發介面（`play(eventId, options)`），支援參數覆寫（音量、Pitch、位置）。
- **事件枚舉**：定義 `SfxEvent` Enum，例如 `UI_CLICK`, `COLOR_FILL`, `CHECK_SUCCESS`，避免字串散落。
- **資料驅動**：建立 `sfx-config.json`（或 TS 常數）描述事件 → Audio 檔案 → 混音設定，方便未來由後端 / CMS 驅動。

### 3.2 音檔載入與快取
- 使用 `AudioBuffer` 預載：進入主畫面時預載 UI & 核心玩法音效，登入後可延遲載入環境 Loop。
- 檔案格式：Web 端使用 `.ogg`（兼容 Chrome/Firefox），保留 `.mp3` 備援；原始 WAV 供編輯。
- 引入 `fetch` + `decodeAudioData`，並配合 `Promise` Pool 避免同時大量解碼導致主執行緒壅塞。

### 3.3 動態混音與分組
- 建立音量分組：`master`, `bgm`, `ui`, `sfx`, `env`。每組搭配 `GainNode`，方便設定音量與 Ducking。
- Ducking 設計：當 `CHECK_SUCCESS`、`CHECK_FAILURE` 等佔用混音時，短暫降低 `bgm` 4 dB、`env` 2 dB，0.6s 後恢復。
- Randomizer：對於重複音效（色塊填色、UI 點擊）加入隨機挑選與 Pitch Shifter（以 `playbackRate` 調整）。

### 3.4 擴充到中大型專案的可替換方案
- 保留導入 Middleware 的選項：
  - **FMOD Studio**：可藉由 WebAssembly 版本接入；優點是視覺化混音與參數遙控，但初期成本高。
  - **Wwise**：Web 端支援度較低，可在之後移植至原生 App 時考慮。
- 現階段建議先以 Web Audio 自行管理，待圖像數量、動態需求提升後再評估 Middleware。

### 3.5 開發流程與模組化
- **Step 1**：重構 `FeedbackService` → 新架構，既有 API 暫保留過渡層，確保不破壞現有邏輯。
- **Step 2**：導入 `sfx-config`，逐步將新音效掛載其中。
- **Step 3**：新增 `SfxTesterComponent`（隱藏於開發模式），方便 QA 直接觸發各事件聆聽。
- **Step 4**：與 UI/UX 協作，為尚未實作的畫面先生成 Dummy 事件，避免日後補音效時需要大改。

## 4. 整合測試與迭代流程

### 4.1 測試階段
- **單元驗證**：透過 `SfxTesterComponent`，確認每個事件播放正確樣本、音量與隨機參數。紀錄對照表與實際音量峰值（使用 Chrome DevTools Audio inspector）。
- **互動測試（灰箱）**：於真機（iOS/Android）與桌面瀏覽器操作以下場景：
  - 快速點擊填色（連續 20 次） → 確保不爆音、不延遲。
  - BGM + SFX 同時播放 → Ducking 是否平滑。
  - 切換頁面（Landing → 遊戲 → 返回） → AudioContext 不重複建立、無殘留聲。
- **情境測試**：模擬實際玩家流程（登入 → 選關 → 填色 → 完成 → 分享），評估整體音景是否疲勞或過於安靜。

### 4.2 驗收標準
- 觸控回饋延遲 < 80 ms；填色音效在觸控後 1 frame 內觸發。
- 音量平衡：UI/SFX 峰值不超過 -6 dBFS，BGM 保持 -12~ -18 dBFS； Ducking 回復時間 < 0.8 秒。
- 隨機化：重複操作（>10 次）相似音色不超過 30% 機率連續出現。
- 行動裝置功耗：在中階手機（如 Pixel 5）上連續操作 10 分鐘，CPU 佔用 < 10%。

### 4.3 迭代節奏
- **週期**：建議以 2 週為單位：
  1. 第 1 週：導入 / 調整核心音效（UI、填色、檢查）。
  2. 第 2 週：環境層、完成動畫、商店等延伸場景。
- 每週安排 1 次聆聽會議（15 分鐘），收集團隊感受與調整需求。

### 4.4 追蹤與監測
- 建立 `音效回饋表單`（Google Form 或 Linear issue template），QA 與玩家可提交「音量偏高/低、延遲、重複感」等問題。
- 接入 `Analytics` 事件：記錄提示使用次數、填色操作頻率，以調整音效疲勞度設計。
- 日後準備多語系化時，將音效設定加入設定頁（音樂音量 / 音效音量 / 靜音），並記錄設定變化。

### 4.5 回歸測試清單（精選）
- BGM 播放 → 進入遊戲 → 檢查答案 → 回首頁：確認音量分組復原。
- 無音訊裝置（靜音模式）下啟動：不應卡住流程，並提示用戶「點擊以啟用音效」。
- 頻繁切換色彩與橡皮擦：無音爆或 `AudioContext` 錯誤。

透過上述流程，可確保音效整合不僅補足觸控回饋，也能在迭代中逐步提升沉浸感，符合 `遊戲音效解決方案整理.md` 所強調的同步性、隨機化與動態混音原則。


